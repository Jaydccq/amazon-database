{% extends "layout.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reviews.css') }}">
    <style>
        .vote-btn {
            cursor: pointer;
            color: #6c757d;
            margin: 0 5px;
            transition: color 0.2s ease-in-out, transform 0.1s ease-in-out;
            background: none;
            border: none;
            padding: 0;
            vertical-align: middle;
        }
        .vote-btn:hover {
            color: #007bff;
            transform: scale(1.1);
        }
        .vote-btn.active {
            color: #007bff;
        }
        .vote-btn.down.active {
            color: #dc3545;
        }
        .vote-btn:disabled {
            color: #adb5bd;
            cursor: not-allowed;
        }
        .helpfulness-score {
            font-size: 0.9em;
            color: #6c757d;
            margin-left: 10px;
            cursor: default;
            user-select: none;
        }
        .review-card {
            border-bottom: 1px solid #eee;
        }
        .review-card:last-child {
            border-bottom: none;
        }
        .stars i {
            color: #ffc107;
        }
        .review-author a {
            font-weight: bold;
            color: #007bff;
            text-decoration: none;
        }
        .review-author a:hover {
            text-decoration: underline;
        }
        .score-updated {
            animation: pulse 0.5s;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card mb-4 sticky-top" style="top: 20px;">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Product Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            {% if product.image %}
                                <img src="{{ product.image }}" alt="{{ product.product_name }}" class="img-fluid rounded mb-3"
                                     style="max-height: 150px;">
                            {% else %}
                                <div class="bg-light text-center rounded mb-3 py-5">
                                    <i class="fas fa-box fa-3x text-muted"></i>
                                </div>
                            {% endif %}
                            <h4><a href="{{ url_for('product.product_detail', product_id=product.id) }}">{{ product.product_name }}</a></h4>
                            <p class="text-muted">{{ product.category_name }}</p>
                        </div>

                        <div class="rating-summary p-3 bg-light rounded mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="h2 mb-0 mr-2">{{ "%.1f"|format(avg_rating|float) }}</div>
                                <div class="stars">
                                    {% set avg_rating_val = avg_rating|float %}
                                    {% for i in range(1, 6) %}
                                        {% if i <= avg_rating_val %}
                                            <i class="fas fa-star"></i>
                                        {% elif i - 0.5 <= avg_rating_val %}
                                            <i class="fas fa-star-half-alt"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <p class="mb-0 text-muted">{{ review_count }} review{% if review_count != 1 %}s{% endif %}</p>
                        </div>

                        {% if current_user.is_authenticated %}
                            {% set has_reviewed = False %}
                            {% for r in reviews %}
                                {% if r.user_id == current_user.id %}
                                    {% set has_reviewed = True %}
                                {% endif %}
                            {% endfor %}

                            <div class="d-grid gap-2">
                                {% if not has_reviewed %}
                                    <a href="{{ url_for('reviews.add_review', product_id=product.id) }}"
                                       class="btn btn-primary btn-block">
                                        <i class="fas fa-star"></i> Write a Review
                                    </a>
                                {% else %}
                                    <button class="btn btn-secondary btn-block" disabled>You've already reviewed</button>
                                {% endif %}
                                <a href="{{ url_for('product.product_detail', product_id=product.id) }}"
                                   class="btn btn-outline-secondary btn-block mt-2">
                                    <i class="fas fa-arrow-left"></i> Back to Product
                                </a>
                            </div>
                        {% else %}
                            <p class="text-center text-muted mt-3"><a href="{{ url_for('users.login') }}">Log in</a> to write a review.</p>
                             <a href="{{ url_for('product.product_detail', product_id=product.id) }}"
                                class="btn btn-outline-secondary btn-block mt-2">
                                <i class="fas fa-arrow-left"></i> Back to Product
                            </a>
                        {% endif %}
                    </div>
                </div>

                <div class="card mb-4 sticky-top" style="top: 350px;">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Rating Distribution</h5>
                    </div>
                    <div class="card-body">
                        {% for star in [5, 4, 3, 2, 1] %}
                            {% set count = rating_distribution.get(star, 0) %}
                            {% set percent = (count / review_count * 100) if review_count > 0 else 0 %}
                            <div class="d-flex align-items-center mb-2">
                                <div style="width: 40px;">{{ star }} <i class="fas fa-star text-warning"
                                                                        style="font-size: 0.7rem;"></i></div>
                                <div class="progress flex-grow-1 mx-2" style="height: 10px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ percent }}%;"
                                         aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div style="width: 30px; text-align: right;" class="text-muted small">{{ count }}</div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Customer Reviews ({{ review_count }})</h4>
                        <small class="text-muted">Showing most helpful first</small>
                    </div>
                    <div class="card-body p-0">
                        {% if reviews %}
                            <ul class="list-group list-group-flush">
                            {% for review in reviews %}
                                <li class="list-group-item review-card py-3 px-3" id="review-{{ review.review_id }}">
                                    <div class="review-header d-flex justify-content-between align-items-center mb-2">
                                        <div class="review-author">
                                             <a href="{{ url_for('reviews.user_reviews', user_id=review.user_id) }}">User {{ review.user_id }}</a>
                                            <small class="text-muted ml-2">{{ review.review_date.strftime('%B %d, %Y') }}</small>
                                        </div>
                                        <div class="stars">
                                            {% for i in range(1, 6) %}
                                                <i class="{% if i <= review.rating %}fas{% else %}far{% endif %} fa-star"></i>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="review-body mb-2">
                                        <p class="review-text mb-1">{{ review.comment }}</p>
                                    </div>
                                    <div class="review-footer d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center vote-container" data-review-id="{{ review.review_id }}">
                                            {% if current_user.is_authenticated %}
                                                {% set can_vote = current_user.id != review.user_id %}

                                                <button class="btn btn-sm vote-btn upvote-btn {% if review.user_vote == 1 %}active{% endif %}"
                                                        data-review-id="{{ review.review_id }}"
                                                        data-vote-type="1"
                                                        {% if not can_vote %}disabled title="Cannot vote on your own review"{% endif %}>
                                                    <i class="fas fa-thumbs-up"></i>
                                                </button>
                                                <span class="upvote-count mr-2 small text-muted">{{ review.upvotes }}</span>

                                                <button class="btn btn-sm vote-btn downvote-btn down {% if review.user_vote == -1 %}active{% endif %}"
                                                        data-review-id="{{ review.review_id }}"
                                                        data-vote-type="-1"
                                                        {% if not can_vote %}disabled title="Cannot vote on your own review"{% endif %}>
                                                    <i class="fas fa-thumbs-down"></i>
                                                </button>
                                                <span class="downvote-count mr-3 small text-muted">{{ review.downvotes }}</span>

                                                <span class="helpfulness-score">
                                                    (<span class="score">{{ review.helpfulness }}</span>) helpful
                                                </span>

                                            {% else %}
                                                <span class="text-muted mr-1"><i class="fas fa-thumbs-up"></i></span>
                                                <span class="upvote-count mr-2 small">{{ review.upvotes }}</span>
                                                <span class="text-muted mr-1"><i class="fas fa-thumbs-down"></i></span>
                                                <span class="downvote-count mr-3 small">{{ review.downvotes }}</span>
                                                <span class="helpfulness-score">
                                                    (<span class="score">{{ review.helpfulness }}</span>) helpful
                                                </span>
                                            {% endif %}
                                            <span class="vote-error text-danger small ml-2" style="display: none;"></span>
                                        </div>

                                        {% if current_user.is_authenticated and current_user.id == review.user_id %}
                                            <div>
                                                <a href="{{ url_for('reviews.edit_review', review_id=review.review_id) }}"
                                                   class="btn btn-sm btn-outline-secondary py-0 px-1" title="Edit your review">
                                                    <i class="fas fa-edit fa-xs"></i> <small>Edit</small>
                                                </a>
                                                <button class="btn btn-sm btn-outline-danger py-0 px-1 delete-review-btn"
                                                        data-review-id="{{ review.review_id }}" title="Delete your review">
                                                    <i class="fas fa-trash-alt fa-xs"></i> <small>Delete</small>
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </li>
                            {% endfor %}
                            </ul>
                        {% else %}
                           <div class="text-center py-5 px-3">
                                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                                <h5>No reviews yet</h5>
                                <p class="text-muted">Be the first to review this product!</p>
                                {% if current_user.is_authenticated %}
                                    {% set has_reviewed = False %}
                                    {% for r in reviews %}
                                        {% if r.user_id == current_user.id %}
                                            {% set has_reviewed = True %}
                                        {% endif %}
                                    {% endfor %}
                                    {% if not has_reviewed %}
                                    <a href="{{ url_for('reviews.add_review', product_id=product.id) }}"
                                       class="btn btn-primary mt-3">
                                        <i class="fas fa-star"></i> Write the First Review
                                    </a>
                                    {% else %}
                                    <button class="btn btn-secondary mt-3" disabled>You've already reviewed</button>
                                    {% endif %}
                                {% else %}
                                    <p class="text-center text-muted mt-3"><a href="{{ url_for('users.login') }}">Log in</a> to write a review.</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="deleteReviewModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this review? This action cannot be undone.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Review</button>
          </div>
        </div>
      </div>
    </div>

    {% if current_user.is_authenticated %}
    <script>
    $(document).ready(function() {
        const baseVoteUrl = "{{ url_for('reviews.vote_review', review_id=0) }}";
        const baseDeleteUrl = "{{ url_for('reviews.delete_review', review_id=0) }}";
        let reviewIdToDelete = null;

        $('.vote-btn').on('click', function(e) {
            e.preventDefault();

            var button = $(this);
            if (button.prop('disabled')) {
                return;
            }

            var reviewId = button.data('review-id');
            var voteType = button.data('vote-type');
            var voteContainer = $('.vote-container[data-review-id="' + reviewId + '"]');

            var upvoteBtn = voteContainer.find('.upvote-btn');
            var downvoteBtn = voteContainer.find('.downvote-btn');
            var upvoteCountSpan = voteContainer.find('.upvote-count');
            var downvoteCountSpan = voteContainer.find('.downvote-count');
            var helpfulnessScoreSpan = voteContainer.find('.helpfulness-score .score');
            var errorDiv = voteContainer.find('.vote-error');

            errorDiv.hide().text('');
            upvoteBtn.prop('disabled', true);
            downvoteBtn.prop('disabled', true);

            var oldScore = parseInt(helpfulnessScoreSpan.text(), 10);

            $.ajax({
                url: baseVoteUrl.replace(/0$/, reviewId),
                type: 'POST',
                data: {
                    vote_type: voteType
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        upvoteCountSpan.text(response.upvotes);
                        downvoteCountSpan.text(response.downvotes);

                        var newScore = response.upvotes - response.downvotes;
                        helpfulnessScoreSpan.text(newScore);

                        if (oldScore !== newScore) {
                            helpfulnessScoreSpan.addClass('score-updated');
                            setTimeout(function() {
                                helpfulnessScoreSpan.removeClass('score-updated');
                            }, 500);
                        }

                        upvoteBtn.removeClass('active');
                        downvoteBtn.removeClass('active');

                        if (response.new_vote_status === 1) {
                            upvoteBtn.addClass('active');
                        } else if (response.new_vote_status === -1) {
                            downvoteBtn.addClass('active');
                        }
                    } else {
                        errorDiv.text('Vote Error: ' + response.error).show();
                    }
                },
                error: function(xhr, status, error) {
                    var errorMsg = 'Could not submit vote. Please try again.';

                    try {
                        var jsonError = JSON.parse(xhr.responseText);
                        if (jsonError && jsonError.error) {
                            errorMsg = jsonError.error;
                        }
                    } catch(e) {}

                    errorDiv.text('Error: ' + errorMsg).show();
                },
                complete: function() {
                    var canVote = upvoteBtn.attr('title') !== 'Cannot vote on your own review';

                    if (canVote) {
                        setTimeout(function() {
                            upvoteBtn.prop('disabled', false);
                            downvoteBtn.prop('disabled', false);
                        }, 300);
                    }
                }
            });
        });

        $('.delete-review-btn').click(function() {
            reviewIdToDelete = $(this).data('review-id');
            $('#deleteReviewModal').modal('show');
        });

        $('#confirmDeleteBtn').click(function() {
            if (!reviewIdToDelete) return;

            var reviewCard = $('#review-' + reviewIdToDelete);
            var errorDiv = reviewCard.find('.vote-error');
            errorDiv.hide().text('');

            $.ajax({
                url: baseDeleteUrl.replace(/0$/, reviewIdToDelete),
                type: 'DELETE',
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        reviewCard.fadeOut(500, function() {
                            $(this).remove();

                            var countElement = $('.card-header h4');
                            var currentText = countElement.text();
                            var match = currentText.match(/\((\d+)\)/);
                            if (match && match[1]) {
                                var currentCount = parseInt(match[1], 10);
                                if (currentCount > 0) {
                                    var newCount = currentCount - 1;
                                    countElement.text('Customer Reviews (' + newCount + ')');
                                    var leftPanelCount = $('.rating-summary .text-muted');
                                    leftPanelCount.text(newCount + ' review' + (newCount !== 1 ? 's' : ''));
                                } else {
                                     countElement.text('Customer Reviews (0)');
                                     $('.rating-summary .text-muted').text('0 reviews');
                                     if ($('.review-card').length === 0) {
                                     }
                                }
                            }
                         });
                         $('#deleteReviewModal').modal('hide');
                    } else {
                        errorDiv.text('Delete Error: ' + response.error).show();
                         $('#deleteReviewModal').modal('hide');
                    }
                },
                error: function(xhr, status, error) {
                    var errorMsg = 'Could not delete review. Please try again.';

                    try {
                        var jsonError = JSON.parse(xhr.responseText);
                        if (jsonError && jsonError.error) {
                            errorMsg = jsonError.error;
                        }
                    } catch(e) {}

                    errorDiv.text('Error: ' + errorMsg).show();
                    $('#deleteReviewModal').modal('hide');
                },
                complete: function() {
                    reviewIdToDelete = null;
                }
            });
        });

        $('#deleteReviewModal').on('hidden.bs.modal', function (e) {
            reviewIdToDelete = null;
        });
    });
    </script>
    {% endif %}
{% endblock %}