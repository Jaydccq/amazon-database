{% extends "layout.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reviews.css') }}"> {# Optional: Link to your custom review CSS #}
    {# Add some basic styles for vote buttons #}
    <style>
        .vote-btn {
            cursor: pointer;
            color: #6c757d; /* Default grey */
            margin: 0 5px;
            transition: color 0.2s ease-in-out, transform 0.1s ease-in-out;
            background: none; /* Ensure transparent background */
            border: none; /* Remove default button border */
            padding: 0; /* Remove default padding */
            vertical-align: middle; /* Align icons better */
        }
        .vote-btn:hover {
            color: #007bff; /* Blue on hover */
            transform: scale(1.1);
        }
        .vote-btn.active {
            color: #007bff; /* Blue when active (upvote) */
        }
        .vote-btn.down.active {
            color: #dc3545; /* Red when active (downvote) */
        }
        .vote-btn:disabled {
            color: #adb5bd;
            cursor: not-allowed;
        }
        .helpfulness-score {
            font-size: 0.9em;
            color: #6c757d;
            margin-left: 10px; /* Add space before helpfulness */
        }
        .review-card {
             border-bottom: 1px solid #eee; /* Separator line */
        }
        .review-card:last-child {
            border-bottom: none; /* No border for the last review */
        }
        .stars i {
             color: #ffc107; /* Gold color for stars */
        }
        .review-author a { /* Style reviewer name link if applicable */
            font-weight: bold;
            color: #007bff;
            text-decoration: none;
        }
        .review-author a:hover {
             text-decoration: underline;
        }

    </style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                 <div class="card mb-4 sticky-top" style="top: 20px;"> {# Make product info sticky #}
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Product Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="text-center mb-4">
                            {% if product.image %}
                                <img src="{{ product.image }}" class="img-fluid rounded mb-3"
                                     style="max-height: 150px;">
                            {% else %}
                                <div class="bg-light text-center rounded mb-3 py-5">
                                    {# Placeholder icon if no image #}
                                    <i class="fas fa-box fa-3x text-muted"></i>
                                </div>
                            {% endif %}
                            {# Link product name back to detail page #}
                             <h4><a href="{{ url_for('product.product_detail', product_id=product.product_id) }}">{{ product.product_name }}</a></h4>
                             {# Display category name #}
                            <p class="text-muted">{{ product.category_name }}</p>
                        </div>

                        {# Overall rating summary #}
                        <div class="rating-summary p-3 bg-light rounded mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="h2 mb-0 mr-2">{{ "%.1f"|format(avg_rating|float) }}</div> {# Ensure avg_rating is float #}
                                <div class="stars">
                                    {# Display stars based on average rating #}
                                    {% set avg_rating_val = avg_rating|float %} {# Ensure float for comparison #}
                                    {% for i in range(1, 6) %}
                                        {% if i <= avg_rating_val %}
                                            <i class="fas fa-star"></i>
                                        {% elif i - 0.5 <= avg_rating_val %}
                                            <i class="fas fa-star-half-alt"></i>
                                        {% else %}
                                            <i class="far fa-star"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <p class="mb-0 text-muted">{{ review_count }} review{% if review_count != 1 %}s{% endif %}</p>
                        </div>

                        {# Write Review and Back Buttons #}
                        {% if current_user.is_authenticated %}
                             {# Check if user has already reviewed this product #}
                             {% set has_reviewed = False %}
                             {% for r in reviews %}
                                 {% if r.user_id == current_user.id %}
                                     {% set has_reviewed = True %}
                                 {% endif %}
                             {% endfor %}

                            <div class="d-grid gap-2">
                                 {% if not has_reviewed %} {# Only show if user hasn't reviewed #}
                                    <a href="{{ url_for('reviews.add_review', product_id=product.product_id) }}"
                                       class="btn btn-primary btn-block">
                                        <i class="fas fa-star"></i> Write a Review
                                    </a>
                                 {% else %}
                                     <button class="btn btn-secondary btn-block" disabled>You've already reviewed</button>
                                 {% endif %}
                                <a href="{{ url_for('product.product_detail', product_id=product.product_id) }}"
                                   class="btn btn-outline-secondary btn-block mt-2">
                                    <i class="fas fa-arrow-left"></i> Back to Product
                                </a>
                            </div>
                        {% else %}
                             {# Prompt non-logged-in users to log in to review #}
                              <p class="text-center text-muted mt-3"><a href="{{ url_for('users.login') }}">Log in</a> to write a review.</p>
                               <a href="{{ url_for('product.product_detail', product_id=product.product_id) }}"
                                   class="btn btn-outline-secondary btn-block mt-2">
                                    <i class="fas fa-arrow-left"></i> Back to Product
                                </a>
                        {% endif %}
                    </div>
                </div>

                 {# Rating Distribution Card #}
                <div class="card mb-4 sticky-top" style="top: 350px;"> {# Adjust top offset as needed #}
                    <div class="card-header bg-light">
                        <h5 class="mb-0">Rating Distribution</h5>
                    </div>
                    <div class="card-body">
                        {% for star in [5, 4, 3, 2, 1] %}
                             {# Calculate count and percentage for each star rating #}
                            {% set count = rating_distribution.get(star, 0) %} {# Use .get for safety #}
                            {% set percent = (count / review_count * 100) if review_count > 0 else 0 %}
                            <div class="d-flex align-items-center mb-2">
                                <div style="width: 40px;">{{ star }} <i class="fas fa-star text-warning" {# Make star yellow #}
                                                                        style="font-size: 0.7rem;"></i></div>
                                <div class="progress flex-grow-1 mx-2" style="height: 10px;"> {# Add margin to progress bar #}
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: {{ percent }}%;" {# Yellow progress bar #}
                                         aria-valuenow="{{ percent }}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div style="width: 30px; text-align: right;" class="text-muted small">{{ count }}</div> {# Show count #}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        {# Display review count, title changed to reflect new sorting #}
                        <h4 class="mb-0">Customer Reviews ({{ review_count }})</h4>
                        {# Sorting controls are removed as sorting is fixed in backend #}
                         <small class="text-muted">Showing most helpful first</small>
                    </div>
                    <div class="card-body p-0"> {# Remove padding to allow full-width border #}
                        {% if reviews %}
                            <ul class="list-group list-group-flush"> {# Use list group for structure #}
                            {% for review in reviews %}
                                <li class="list-group-item review-card py-3 px-3" id="review-{{ review.review_id }}"> {# Add ID and padding #}
                                    <div class="review-header d-flex justify-content-between align-items-center mb-2">
                                        <div class="review-author">
                                            {# Link to user profile if available, otherwise show user ID #}
                                            {# Replace with actual user lookup if possible #}
                                            <a href="#">User {{ review.user_id }}</a> {# Placeholder Link #}
                                             <small class="text-muted ml-2">{{ review.review_date.strftime('%B %d, %Y') }}</small> {# Nicer date format #}
                                        </div>
                                        <div class="stars">
                                            {# Display review rating stars #}
                                            {% for i in range(1, 6) %}
                                                <i class="{% if i <= review.rating %}fas{% else %}far{% endif %} fa-star"></i>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="review-body mb-2">
                                        {# Display review comment #}
                                        <p class="review-text mb-1">{{ review.comment }}</p>
                                    </div>
                                    <div class="review-footer d-flex justify-content-between align-items-center">
                                        {# --- Voting Section --- #}
                                        <div class="d-flex align-items-center">
                                            {% if current_user.is_authenticated %}
                                                {# Prevent voting on own review #}
                                                {% set can_vote = current_user.id != review.user_id %}

                                                {# Upvote button #}
                                                <button class="btn btn-sm vote-btn upvote-btn {% if review.user_vote == 1 %}active{% endif %}"
                                                        data-review-id="{{ review.review_id }}"
                                                        data-vote-type="1"
                                                        {% if not can_vote %}disabled title="Cannot vote on your own review"{% endif %}>
                                                    <i class="fas fa-thumbs-up"></i>
                                                </button>
                                                <span class="upvote-count mr-2 small text-muted">{{ review.upvotes }}</span> {# Show upvote count #}

                                                {# Downvote button #}
                                                <button class="btn btn-sm vote-btn downvote-btn down {% if review.user_vote == -1 %}active{% endif %}"
                                                        data-review-id="{{ review.review_id }}"
                                                        data-vote-type="-1"
                                                         {% if not can_vote %}disabled title="Cannot vote on your own review"{% endif %}>
                                                    <i class="fas fa-thumbs-down"></i>
                                                </button>
                                                <span class="downvote-count mr-3 small text-muted">{{ review.downvotes }}</span> {# Show downvote count #}

                                                {# Display helpfulness score dynamically #}
                                                <span class="helpfulness-score">
                                                     (<span class="score">{{ review.helpfulness }}</span>) helpful
                                                </span>

                                            {% else %}
                                                {# Show counts but disable buttons for logged-out users #}
                                                <span class="text-muted mr-1"><i class="fas fa-thumbs-up"></i></span>
                                                <span class="upvote-count mr-2 small">{{ review.upvotes }}</span>
                                                 <span class="text-muted mr-1"><i class="fas fa-thumbs-down"></i></span>
                                                <span class="downvote-count mr-3 small">{{ review.downvotes }}</span>
                                                 <span class="helpfulness-score">
                                                     (<span class="score">{{ review.helpfulness }}</span>) helpful
                                                </span>
                                            {% endif %}
                                            {# Display vote error messages here #}
                                            <span class="vote-error text-danger small ml-2" style="display: none;"></span>
                                        </div>
                                        {# --- End Voting Section --- #}

                                        {# Edit button for own review #}
                                        {% if current_user.is_authenticated and current_user.id == review.user_id %}
                                            <div>
                                                <a href="{{ url_for('reviews.edit_review', review_id=review.review_id) }}"
                                                   class="btn btn-sm btn-outline-warning">
                                                    <i class="fas fa-edit"></i> Edit
                                                </a>
{#                                                <button class="btn btn-sm btn-danger delete-review" data-review-id="{{ review.review_id }}">#}
{#                                                    Delete#}
{#                                                </button>#}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                                <h5>No reviews yet</h5>
                                <p class="text-muted">Be the first to review this product!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Delete modal if you implement delete functionality in JS ... #}
    {# Example:
    <div class="modal fade" id="deleteReviewModal" ...> ... </div>
    #}

    {# --- Add Javascript for voting --- #}
    {% if current_user.is_authenticated %}
    <script>
    $(document).ready(function() {
        // --- Vote Button Click Handler ---
        $('.vote-btn').click(function(e) {
            e.preventDefault(); // Prevent default button action

            var button = $(this);
            // Prevent multiple clicks while processing
            if (button.prop('disabled')) {
                return;
            }

            var reviewId = button.data('review-id');
            var voteType = button.data('vote-type');
            var reviewCard = button.closest('.review-card'); // Find the parent list item
            var errorDiv = reviewCard.find('.vote-error');
            var upvoteBtn = reviewCard.find('.upvote-btn');
            var downvoteBtn = reviewCard.find('.downvote-btn');
            var upvoteCountSpan = reviewCard.find('.upvote-count');
            var downvoteCountSpan = reviewCard.find('.downvote-count');
            var helpfulnessSpan = reviewCard.find('.helpfulness-score .score');

            // Disable buttons during request
            upvoteBtn.prop('disabled', true);
            downvoteBtn.prop('disabled', true);
            errorDiv.hide().text(''); // Clear previous errors

            $.ajax({
                url: '/reviews/vote/' + reviewId, // Target the vote endpoint
                type: 'POST',
                data: {
                    vote_type: voteType,
                    // Include CSRF token if using Flask-WTF CSRF protection
                    // csrf_token: '{{ csrf_token() }}'
                },
                dataType: 'json', // Expect JSON response
                success: function(response) {
                    if (response.success) {
                        // Update counts displayed on page
                        upvoteCountSpan.text(response.upvotes);
                        downvoteCountSpan.text(response.downvotes);
                        helpfulnessSpan.text(response.upvotes - response.downvotes); // Recalculate helpfulness

                        // Update button 'active' state visually
                        upvoteBtn.removeClass('active');
                        downvoteBtn.removeClass('active');
                        if (response.new_vote_status == 1) {
                            upvoteBtn.addClass('active'); // Highlight upvote
                        } else if (response.new_vote_status == -1) {
                            downvoteBtn.addClass('active'); // Highlight downvote
                        }
                    } else {
                        // Show error message from server
                        errorDiv.text('Vote Error: ' + response.error).show();
                        // Optionally revert counts/buttons if needed on error
                        // For simplicity, current state might remain until refresh
                    }
                },
                error: function(xhr, status, error) {
                    // Handle AJAX errors (network, server crash, etc.)
                    var errorMsg = 'Could not submit vote. Please try again.';
                     try { // Try to parse server error response
                         var jsonError = JSON.parse(xhr.responseText);
                         if(jsonError && jsonError.error) {
                             errorMsg = jsonError.error; // Use server's error message
                         }
                     } catch(e) { /* Ignore parsing error */ }
                     errorDiv.text('Error: ' + errorMsg).show();
                },
                complete: function() {
                    // Re-enable buttons unless they were initially disabled (e.g., own review)
                     if (upvoteBtn.attr('title') !== 'Cannot vote on your own review') {
                        upvoteBtn.prop('disabled', false);
                     }
                      if (downvoteBtn.attr('title') !== 'Cannot vote on your own review') {
                        downvoteBtn.prop('disabled', false);
                     }
                }
            });
        });


        let reviewToDelete = null;
        $('.delete-review-btn').click(function() { // Assuming a button with this class
             reviewToDelete = $(this).data('review-id');
             $('#deleteReviewModal').modal('show'); // Show confirmation modal
         });
         $('#confirmDelete').click(function() { // Button inside the modal
             if (reviewToDelete) {
                 $.ajax({
                     url: '/api/reviews/delete/' + reviewToDelete, // Target delete API
                     type: 'DELETE',
                    // data: { csrf_token: '{{ csrf_token() }}' }, // Include CSRF if needed
                     success: function(result) {
                         if (result.success) {
                             $('#review-' + reviewToDelete).fadeOut(500, function() { $(this).remove(); }); // Remove review from page
                             // Optionally update review count display
                        } else {
                         alert('Delete failed: ' + result.error);
                         }
                    },
                    error: function() {
                          alert('Could not delete review. Please try again.');
                     }
                 });
             }
             $('#deleteReviewModal').modal('hide');
         });
    });
    </script>
    {% endif %}

{% endblock %}
